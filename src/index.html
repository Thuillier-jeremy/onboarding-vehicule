<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pr√©paration dossier v√©hicule</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      margin:0;
      background:#0f0f12;
      color:#fff;
    }

    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:18px;
    }

    .logo{
      display:flex;
      justify-content:center;
      margin:20px 0 10px;
    }

    .logo img{
      max-width:260px;
      width:min(70%,260px);
      height:auto;
    }

    .card{
      background:#17181d;
      border:1px solid #2a2b33;
      border-radius:14px;
      padding:16px;
      margin:12px 0;
    }

    h1{
      font-size:20px;
      margin:6px 0 10px;
    }

    label{
      display:block;
      margin:10px 0 6px;
      font-size:14px;
      opacity:.9;
    }

    input, textarea, button{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid #2a2b33;
      background:#0f0f12;
      color:#fff;
      box-sizing:border-box;
    }

    textarea{
      resize:vertical;
      min-height:80px;
    }

    input[type="file"]{
      padding:10px;
    }

    .hint{
      font-size:12px;
      opacity:.75;
      margin-top:6px;
      line-height:1.35;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    @media (max-width:640px){
      .row{ grid-template-columns:1fr; }
    }

    button{
      cursor:pointer;
      border:none;
      background:#3b82f6;
      font-weight:700;
      margin-top:10px;
    }

    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGO -->
    <div class="logo">
      <img src="/assets/logo-bernier-blanc.png" alt="Groupe Bernier">
    </div>

    <!-- TITRE -->
    <div class="card">
      <h1>Pr√©paration de votre dossier atelier</h1>
      <div class="hint">
        Merci de compl√©ter ce formulaire et d‚Äôenvoyer :
        <b>1 photo de la carte grise</b> et, si besoin,
        <b>des photos des d√©g√¢ts</b>.
      </div>
    </div>

    <!-- FORMULAIRE -->
    <form id="onboardingForm" class="card" enctype="multipart/form-data">

      <label for="nom">Nom / Pr√©nom *</label>
      <input id="nom" name="nom" required>

      <label for="email">Adresse e-mail *</label>
      <input id="email" name="email" type="email" required>

      <label for="telephone">T√©l√©phone *</label>
      <input id="telephone" name="telephone" type="tel" required>

      <label for="adresse">Adresse postale *</label>
      <textarea id="adresse" name="adresse_postale" required></textarea>

      <label for="immat">Immatriculation (si connue)</label>
      <input id="immat" name="immatriculation" placeholder="AA-123-BB">

      <label for="cg">Photo de la carte grise *</label>
      <input id="cg"
             name="carte_grise"
             type="file"
             accept="image/*"
             capture="environment"
             required>

      <div class="hint">Merci de prendre une photo nette et lisible.</div>

      <label>Photos des d√©g√¢ts (si concern√©s)</label>
      <input name="degat_1" type="file" accept="image/*" capture="environment">
      <input name="degat_2" type="file" accept="image/*" capture="environment">
      <input name="degat_3" type="file" accept="image/*" capture="environment">
      <input name="degat_4" type="file" accept="image/*" capture="environment">
      <input name="degat_5" type="file" accept="image/*" capture="environment">
      <input name="degat_6" type="file" accept="image/*" capture="environment">

      <div class="hint">
        Astuce : privil√©giez le Wi-Fi ou un bon r√©seau mobile.
      </div>

      <button id="btn" type="submit">Envoyer mon dossier</button>
      <div id="msg" class="hint"></div>
    </form>

    <!-- RGPD -->
    <div class="card">
      <div class="hint">
        Les informations et photos transmises sont utilis√©es uniquement
        pour la prise en charge de votre v√©hicule et conserv√©es conform√©ment
        √† la r√©glementation en vigueur.
      </div>
    </div>

  </div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- JS ENVOI VERS AZURE FUNCTION -->
 <script>
  const form = document.getElementById("onboardingForm");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");

  // üîÅ Convertit un File en ArrayBuffer (pour ZIP)
  function fileToArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // Nettoyage l√©ger pour nom de fichier
  function safe(s) {
    return (s || "")
      .toString()
      .trim()
      .replace(/[^\w\-]+/g, "_")
      .slice(0, 60);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    btn.disabled = true;
    msg.textContent = "Pr√©paration du dossier‚Ä¶";

    try {
      // ‚úÖ Mets ici TON lien "Demande de fichiers"
      const FILE_REQUEST_URL = "https://groupebernier.sharepoint.com/sites/plqautresmarques/Documents%20partages/Forms/AllItems.aspx?id=%2Fsites%2Fplqautresmarques%2FDocuments%20partages%2FPARTAGE%20PLAQUE%2F03%20%2D%20APV%20ET%20PR%2F02%20%2D%20DOCUMENTS%20APV%20GROUPE%2F%2D%2006%20COMMUN%2FOnboarding&viewid=30bff939%2Db0ac%2D43b6%2D90a0%2D405d062045f5&FolderCTID=0x012000B772FC0096AEE447B119BF742707528E";

      // 1) R√©cup√©ration champs
      const payload = {
  nom: form.elements["nom"].value.trim(),
  email: form.elements["email"].value.trim(),
  telephone: form.elements["telephone"].value.trim(),
  adresse_postale: form.elements["adresse_postale"].value.trim(),
  immatriculation: form.elements["immatriculation"].value.trim(),
  submittedAt: new Date().toISOString()
};
      // 2) Pr√©pare ZIP
      const zip = new JSZip();
      zip.file("recap.json", JSON.stringify(payload, null, 2));

      // 3) Ajoute les fichiers (carte grise + d√©g√¢ts)
      const fileInputs = Array.from(form.querySelectorAll('input[type="file"]'));
      let added = 0;

      for (const input of fileInputs) {
        if (!input.files || input.files.length === 0) continue;
        const file = input.files[0];

        // limite simple (ex: 8 Mo)
        const maxBytes = 8 * 1024 * 1024;
        if (file.size > maxBytes) {
          throw new Error(`Le fichier "${file.name}" est trop lourd (max 8 Mo).`);
        }

        const ab = await fileToArrayBuffer(file);
        const folder = input.name === "carte_grise" ? "carte_grise" : "degats";
        zip.file(`${folder}/${input.name}_${safe(file.name)}`, ab);
        added++;
      }

      if (added === 0) {
        throw new Error("Aucun fichier ajout√©. Merci d‚Äôajouter au minimum la carte grise.");
      }

      msg.textContent = "G√©n√©ration du ZIP‚Ä¶";

      // 4) G√©n√®re le ZIP
      const blob = await zip.generateAsync({ type: "blob" });

      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      const zipName = `Onboarding_${stamp}_${safe(payload.nom)}_${safe(payload.immatriculation || "immat_inconnue")}.zip`;

      // 5) T√©l√©charge le ZIP
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = zipName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      // 6) Ouvre la page d‚Äôupload (file request)
      msg.textContent = "ZIP pr√™t ‚úÖ. Une page s‚Äôouvre pour d√©poser le fichier.";
      window.open(FILE_REQUEST_URL, "_blank");
setTimeout(() => window.location.href = "/merci.html", 800);

      // Option : redirection vers merci
      window.location.href = "/merci.html";

    } catch (err) {
      btn.disabled = false;
      msg.textContent = "Erreur : " + err.message;
    }
  });
</script>



</body>
</html>
